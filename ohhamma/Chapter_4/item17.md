# 변경 가능성을 최소화하라

- 불변 클래스 : 인스턴스의 내부 값을 수정할 수 없는 클래스

## 클래스를 불변으로 만들기 위한 규칙

- 객체의 상태를 변경하는 메서드(변경자)를 제공하지 않는다
- 클래스를 확장할 수 없도록 한다
- 모든 필드를 `final`로 선언한다
- 모든 필드를 `private`로 선언한다
- 자신 외에는 내부의 가변 컴포넌트에 접근할 수 없도록 한다 : 방어적 복사 수행

## 불변 객체의 장점

### 불변 객체는 단순하다

- 함수형 프로그래밍 : 피연산자에 함수를 적용해 결과 반환, 피연산자 자체는 그대로
    - 불변이 되는 영역의 비율↑
- 불변 객체는 생성된 시점의 상태를 파괴될 때까지 그대로 간직한다

### 불변 객체는 근본적으로 스레드 안전하여 따로 동기화할 필요 없다

- 불변 객체는 안심하고 공유할 수 있다
- 불변 클래스 → 한번 만든 인스턴스 최대한 재활용하자
    - 정적 팩터리 사용하여 메모리 사용량↓
- 자주 쓰이는 값들을 상수로 제공 : `public static final`
- 방어적 복사 필요x → clone 메서드나 복사 생성자 제공x

### 불변 객체는 자유롭게 공유할 수 있음은 물론, 불변 객체끼리는 내부 데이터를 공유할 수 있다

- BigInteger 클래스 : sign, magnitude

### 객체를 만들 때 다른 불변 객체들을 구성요소로 사용하면 이점이 많다

- 구조가 아무리 복잡하더라도 불변식을 유지하기 훨씬 수월해짐
- 불변 객체는 맵의 키와 집합(Set)의 우너소로 쓰기에 안성맞춤

### 불변 객체는 그 자체로 실패 원자성을 제공한다

- 실패 원자성 : 메서드에서 예외 발생 후에도 그 객체는 여전히 메서드 호출 전과 같은 유효한 상태여야 한다

## 불변 클래스의 단점

### 값이 다르면 반드시 독립된 객체로 만들어야 한다

- 생성 시 비용↑
- 객체 완성까지 단계가 많은 경우에 대처하기
    - 다단계 연산을 예측하여 기본 기능으로 제공 : 가변 동반 클래스 (StringBuilder)
    - 예측이 어려운 경우에는 클래스를 public으로 제공 (String)

## 불변 클래스를 만드는 또 다른 설계 방법

- 자신을 상속하지 못하게 해야 함
    - final 클래스로 선언
    - 모든 생성자를 private 혹은 package-private로 만들고 public 정적 팩터리 제공
    - 신뢰할 수 없는 하위 클래스의 인스턴스라고 확인 → 가변이라 가정하고 방어적으로 복사해 사용해야함
- 어떤 메서드도 객체의 상태 중 외부에 비치는 값을 변경할 수 없다
    - 계산 비용이 큰 값을 나중에 계산 → final이 아닌 필드에 캐시
- 클래스는 꼭 필요한 경우가 아니라면 불변이어야 한다
- 불변으로 만들 수 없는 클래스라도 변경할 수 있는 부분을 최소한으로 줄이자
    - 다른 합당한 이유가 없다면 모든 필드는 `private final`이어야 한다
- 생성자는 불변식 설정이 모두 완료된, 초기화가 완벽히 끝난 상태의 객체를 생성해야 한다