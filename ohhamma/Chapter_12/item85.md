# 자바 직렬화의 대안을 찾으라

```
💡 직렬화는 위험하니 피해야 한다. 신뢰할 수 없는 데이터는 역직렬화하지 말자.
```

## 직렬화의 문제

- 공격범위가 너무 넓고 지속적으로 더 넒어짐 → 방어하기 어려움
- `readObject` : 클래스패스 안의 거의 모든 타입의 객체 생성 가능
    - 호출 시 객체 그래프 역직렬화
    - 바이트 스트림 역직렬화 → 내부의 모든 코드 수행 가능
- 서드파티 라이브러리, 애플리케이션 → 모두 공격 범위에 포함

### 가젯

- 역직렬화 과정에서 호출되어 잠재적으로 위험한 동작을 수행하는 메서드
- 여러 가젯 함께 사용 → 가젯 체인 구성
- 신중하게 제작한 바이트 스트림만 역직렬화해야 함

### 역직렬화 폭탄

- 역직렬화에 시간이 오래 걸리는 짧은 스트림
- 역질렬화 시 → 서비스 거부 공격에 쉽게 노출

```java
static byte[] bomb() {
	Set<Object> root = new HashSet<>();
	Set<Object> s1 = root;
	Set<Object> s2 = new HashSet<>();
	for (int i = 0; i < 100; i++) {
		Set<Object> t1 = new HashSet<>();
		Set<Object> t2 = new HashSet<>();
		t1.add("foo"); // t1와 t2를 다르게 만든다.
		s1.add(t1); s1.add(t2);
		s2.add(t1); s2.add(t2);
		s1 = t1;
		s2 = t2;
	}
	return serialize(root);
}
```

## 대처 방법

```
💡 직렬화 위험을 회피하는 가장 좋은 방법은 아무것도 역직렬화하지 않는 것이다.
```

- 작성하는 프로그램에서 자바 직렬화를 써야 할 이유가 전혀 없다 !

### 크로스-플랫폼 구조화된 데이터 표현

- 자바 직렬화의 여러 위험 회피
- 다양한 플랫폼 지원, 우수한 성능, 풍부한 지원 도구, 활발한 커뮤니티 등의 이점 제공
- 자바 직렬화보다 훨씬 간단
- 속성-값 쌍의 집합으로 구성된 간단하고 구조화된 데이터 객체 사용
- 기본 타입, 배열 타입만 지원

### JSON & 프로토콜 버퍼

- 크로스-플랫폼 구조화된 데이터 표현의 선두주자
- **JSON** : 브라우저와 서버의 통신용 (자바스크립트용)
    - 텍스트 기반 (가독성↑)
    - 오직 데이터 표현을 위해 사용
- **프로토콜 버퍼** : 서버 사이에 데이터 교환 및 저장 (C++용)
    - 이진 표현 (효율↑)
    - 텍스트 표현도 지원 (pbtxt)
    - 문서를 위한 스키마 제공

### 신뢰할 수 없는 데이터는 절대 역직렬화하지 말자

- **객체 역직렬화 필터링** : 데이터 스트림이 역직렬화되기 전에 필터 설치
    - **화이트리스트 방식** : 기본 거부 모드에서 안전한 클래스만 수용
    - **BUT** 직렬화 폭탄은 거르지 x
- 스왓(SWAT) : 화이트리스트를 자동으로 생성해주는 도구